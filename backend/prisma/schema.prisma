// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ユーザー権限
enum Role {
  ADMIN // 管理者
  STAFF // スタッフ
}

// シフト月のステータス
enum ShiftMonthStatus {
  OPEN      // 提出受付中
  CLOSED    // 提出締切
  PUBLISHED // シフト確定・公開済み
}

// ユーザーテーブル
model User {
  id          String   @id @default(cuid())
  firebaseUid String   @unique @map("firebase_uid")
  email       String   @unique
  name        String
  role        Role     @default(STAFF)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  isDeleted   Boolean  @default(false) @map("is_deleted")

  // リレーション
  shiftRequests         ShiftRequest[]
  shifts                Shift[]
  shiftMonthSubmissions ShiftMonthSubmission[]

  @@map("users")
}

// 招待トークンテーブル
model InvitationToken {
  id        String   @id @default(cuid())
  token     String   @unique // ランダム生成されたトークン
  email     String   // 招待されたユーザーのメールアドレス
  name      String   // ユーザー名
  role      Role     @default(STAFF) // 権限
  expiresAt DateTime // 有効期限
  used      Boolean  @default(false) // 使用済みフラグ
  createdAt DateTime @default(now()) @map("created_at")

  @@map("invitation_tokens")
}

// 月ごとのステータス管理テーブル
model ShiftMonth {
  id        String           @id @default(cuid())
  yearMonth String           @unique @map("year_month") // YYYY-MM形式
  openAt    DateTime         @map("open_at") // 基本 15日 0:00:00
  closeAt   DateTime         @map("close_at") // 基本 20日 23:59:59
  status    ShiftMonthStatus @default(OPEN)
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  // リレーション
  submissions ShiftMonthSubmission[]
  shifts      Shift[]

  @@map("shift_months")
}

// 日ごとの必要人数テーブル
model ShiftRequirement {
  id            String   @id @default(cuid())
  date          DateTime @unique // 日付（YYYY-MM-DD）
  requiredCount Int      @default(0) @map("required_count") // 0〜3
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("shift_requirements")
}

// ユーザーの提出した希望シフト
model ShiftRequest {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  date      DateTime // 希望する勤務日（YYYY-MM-DD）
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // リレーション
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date]) // 同じユーザー・同じ日付は1件のみ
  @@map("shift_requests")
}

// 確定したシフト
model Shift {
  id           String     @id @default(cuid())
  shiftMonthId String     @map("shift_month_id")
  date         DateTime   @db.Date // 勤務日（YYYY-MM-DD）
  userId       String?    @map("user_id") // nullableにする（空欄可）
  isManual     Boolean    @default(false) @map("is_manual") // 手動設定かどうか
  slot         Int        @default(1) // 何番目の枠か (1 or 2)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // リレーション
  shiftMonth ShiftMonth @relation(fields: [shiftMonthId], references: [id], onDelete: Cascade)
  user       User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([shiftMonthId, date, slot]) // 同じ日・同じ枠に重複なし
  @@map("shifts")
}

// シフト月の提出状態管理テーブル
model ShiftMonthSubmission {
  id           String     @id @default(cuid())
  userId       String     @map("user_id")
  shiftMonthId String     @map("shift_month_id")
  submittedAt  DateTime   @default(now()) @map("submitted_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // リレーション
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  shiftMonth ShiftMonth @relation(fields: [shiftMonthId], references: [id], onDelete: Cascade)

  @@unique([userId, shiftMonthId])
  @@map("shift_month_submissions")
}
